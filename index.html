<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnyoneAI - Video Access Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #38bdf8;
            margin-bottom: 1.5rem;
        }
        h2 {
            color: #94a3b8;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #94a3b8;
        }
        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #334155;
            border-radius: 8px;
            background: #0f172a;
            color: #e2e8f0;
            font-size: 1rem;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #38bdf8;
        }
        button {
            background: #38bdf8;
            color: #0f172a;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #7dd3fc;
        }
        button:disabled {
            background: #475569;
            cursor: not-allowed;
        }
        button.secondary {
            background: #475569;
            color: #e2e8f0;
        }
        button.secondary:hover {
            background: #64748b;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .status.success {
            background: #064e3b;
            color: #6ee7b7;
        }
        .status.error {
            background: #7f1d1d;
            color: #fca5a5;
        }
        .status.info {
            background: #1e3a5f;
            color: #7dd3fc;
        }
        .hidden {
            display: none;
        }
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .user-email {
            color: #38bdf8;
        }
        video {
            width: 100%;
            border-radius: 8px;
            background: #000;
        }
        .video-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .video-item {
            padding: 0.75rem;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background 0.2s;
        }
        .video-item:hover {
            background: #334155;
        }
        .video-item .title {
            font-weight: 500;
        }
        .video-item .meta {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .filters select {
            flex: 1;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• AnyoneAI Video Access</h1>

        <!-- Login Section -->
        <div id="login-section" class="card">
            <h2>Iniciar Sesi√≥n</h2>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="tu@email.com">
            </div>
            <button id="btn-magic-link">Enviar Magic Link</button>
            <div id="login-status" class="status info hidden"></div>
        </div>

        <!-- Logged In Section -->
        <div id="app-section" class="hidden">
            <div class="card">
                <div class="user-info">
                    <span>Logueado como: <strong class="user-email" id="user-email"></strong></span>
                    <button class="secondary" id="btn-logout">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <!-- Video Browser -->
            <div class="card">
                <h2>üìÅ Explorar Videos</h2>
                
                <div class="filters">
                    <select id="filter-cohort">
                        <option value="">Todos los cohortes</option>
                    </select>
                    <select id="filter-sprint">
                        <option value="">Todos los sprints</option>
                    </select>
                </div>

                <div id="video-list" class="video-list">
                    <div class="loading">Cargando videos...</div>
                </div>
            </div>

            <!-- Video Player -->
            <div id="player-section" class="card hidden">
                <h2>‚ñ∂Ô∏è Reproducir Video</h2>
                <div id="player-status" class="status info hidden"></div>
                <video id="video-player" controls></video>
                <p id="video-title" style="margin-top: 1rem; color: #94a3b8;"></p>
            </div>

            <!-- Manual Test -->
            <div class="card">
                <h2>üß™ Test Manual</h2>
                <div class="form-group">
                    <label for="recording-id">Recording ID</label>
                    <input type="number" id="recording-id" placeholder="Ej: 1">
                </div>
                <button id="btn-test">Obtener URL</button>
                <div id="test-status" class="status info hidden"></div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // Configuraci√≥n de Supabase - ACTUALIZAR CON TU ANON KEY
            const SUPABASE_URL = 'https://qqvrwuttwvvgixngwcpo.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxdnJ3dXR0d3Z2Z2l4bmd3Y3BvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEwMDg5MDEsImV4cCI6MjA0NjU4NDkwMX0.WR74Hy9w8-NNTFUQ1rSfNnyJuSMNJVUc_B4Aia1Ejbo';  // <-- CAMBIAR ESTO
            
            // Inicializar cliente de Supabase
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            let currentSession = null;

            // Elementos del DOM
            const loginSection = document.getElementById('login-section');
            const appSection = document.getElementById('app-section');
            const emailInput = document.getElementById('email');
            const loginStatus = document.getElementById('login-status');
            const userEmail = document.getElementById('user-email');
            const filterCohort = document.getElementById('filter-cohort');
            const filterSprint = document.getElementById('filter-sprint');
            const videoList = document.getElementById('video-list');
            const playerSection = document.getElementById('player-section');
            const playerStatus = document.getElementById('player-status');
            const videoPlayer = document.getElementById('video-player');
            const videoTitle = document.getElementById('video-title');
            const recordingIdInput = document.getElementById('recording-id');
            const testStatus = document.getElementById('test-status');

            // Event listeners
            document.getElementById('btn-magic-link').addEventListener('click', sendMagicLink);
            document.getElementById('btn-logout').addEventListener('click', logout);
            document.getElementById('btn-test').addEventListener('click', testGetVideoUrl);
            filterCohort.addEventListener('change', loadVideos);
            filterSprint.addEventListener('change', loadVideos);

            // Verificar sesi√≥n al cargar
            async function checkSession() {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session) {
                    currentSession = session;
                    showApp(session.user);
                } else {
                    showLogin();
                }

                // Escuchar cambios de auth
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log('Auth event:', event);
                    if (session) {
                        currentSession = session;
                        showApp(session.user);
                    } else {
                        showLogin();
                    }
                });
            }

            // Enviar magic link
            async function sendMagicLink() {
                const email = emailInput.value;
                
                if (!email) {
                    showStatus(loginStatus, 'Por favor ingresa tu email', 'error');
                    return;
                }

                try {
                    const { error } = await supabaseClient.auth.signInWithOtp({
                        email: email,
                        options: {
                            emailRedirectTo: window.location.href
                        }
                    });

                    if (error) throw error;

                    showStatus(loginStatus, '‚úÖ Magic link enviado! Revis√° tu email.', 'success');
                } catch (error) {
                    showStatus(loginStatus, '‚ùå Error: ' + error.message, 'error');
                }
            }

            // Cerrar sesi√≥n
            async function logout() {
                await supabaseClient.auth.signOut();
                currentSession = null;
                showLogin();
            }

            // Mostrar login
            function showLogin() {
                loginSection.classList.remove('hidden');
                appSection.classList.add('hidden');
            }

            // Mostrar app
            async function showApp(user) {
                loginSection.classList.add('hidden');
                appSection.classList.remove('hidden');
                userEmail.textContent = user.email;
                
                await loadFilters();
                await loadVideos();
            }

            // Cargar filtros (cohortes y sprints)
            async function loadFilters() {
                const { data: cohorts } = await supabaseClient
                    .from('zoom_recordings')
                    .select('cohort')
                    .order('cohort', { ascending: false });

                const uniqueCohorts = [...new Set(cohorts?.map(c => c.cohort) || [])];
                
                filterCohort.innerHTML = '<option value="">Todos los cohortes</option>';
                uniqueCohorts.forEach(cohort => {
                    filterCohort.innerHTML += '<option value="' + cohort + '">' + cohort + '</option>';
                });
            }

            // Cargar videos
            async function loadVideos() {
                const cohort = filterCohort.value;
                const sprint = filterSprint.value;
                
                videoList.innerHTML = '<div class="loading">Cargando videos...</div>';

                let query = supabaseClient
                    .from('zoom_recordings')
                    .select('*')
                    .order('cohort', { ascending: false })
                    .order('sprint')
                    .order('recorded_at', { ascending: false })
                    .limit(50);

                if (cohort) query = query.eq('cohort', cohort);
                if (sprint) query = query.eq('sprint', sprint);

                const { data: videos, error } = await query;

                if (error) {
                    videoList.innerHTML = '<div class="status error">Error: ' + error.message + '</div>';
                    return;
                }

                if (!videos || videos.length === 0) {
                    videoList.innerHTML = '<div class="loading">No se encontraron videos</div>';
                    return;
                }

                // Actualizar filtro de sprints basado en cohort seleccionado
                if (cohort) {
                    const sprints = [...new Set(videos.map(v => v.sprint))];
                    filterSprint.innerHTML = '<option value="">Todos los sprints</option>';
                    sprints.forEach(s => {
                        filterSprint.innerHTML += '<option value="' + s + '">' + s + '</option>';
                    });
                }

                videoList.innerHTML = '';
                videos.forEach(video => {
                    const item = document.createElement('div');
                    item.className = 'video-item';
                    item.innerHTML = '<div class="title">' + video.filename + '</div>' +
                        '<div class="meta">' + video.cohort + ' / ' + video.sprint + ' ‚Ä¢ ' +
                        video.file_size_mb + ' MB ‚Ä¢ ' + (video.recording_type || 'video') + '</div>';
                    item.addEventListener('click', () => playVideo(video.id, video.filename));
                    videoList.appendChild(item);
                });
            }

            // Reproducir video
            async function playVideo(recordingId, filename) {
                playerSection.classList.remove('hidden');
                showStatus(playerStatus, '‚è≥ Obteniendo URL del video...', 'info');
                videoPlayer.src = '';
                videoTitle.textContent = filename;

                try {
                    const url = await getPresignedUrl(recordingId);
                    videoPlayer.src = url;
                    playerStatus.classList.add('hidden');
                } catch (error) {
                    showStatus(playerStatus, '‚ùå Error: ' + error.message, 'error');
                }
            }

            // Obtener URL pre-firmada
            async function getPresignedUrl(recordingId) {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (!session) {
                    throw new Error('No hay sesi√≥n activa');
                }

                const response = await fetch(SUPABASE_URL + '/functions/v1/get-video-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + session.access_token
                    },
                    body: JSON.stringify({ recording_id: recordingId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error obteniendo URL');
                }

                return data.url;
            }

            // Test manual
            async function testGetVideoUrl() {
                const recordingId = recordingIdInput.value;

                if (!recordingId) {
                    showStatus(testStatus, 'Ingresa un Recording ID', 'error');
                    return;
                }

                showStatus(testStatus, '‚è≥ Obteniendo URL...', 'info');

                try {
                    const url = await getPresignedUrl(parseInt(recordingId));
                    showStatus(testStatus, '‚úÖ URL obtenida!\n\n' + url.substring(0, 100) + '...', 'success');
                    console.log('Full URL:', url);
                } catch (error) {
                    showStatus(testStatus, '‚ùå Error: ' + error.message, 'error');
                }
            }

            // Mostrar status
            function showStatus(element, message, type) {
                element.textContent = message;
                element.className = 'status ' + type;
                element.classList.remove('hidden');
            }

            // Inicializar
            checkSession();
        })();
    </script>
</body>
</html>
